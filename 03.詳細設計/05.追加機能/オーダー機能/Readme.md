# ボードゲームカフェ オーダー機能設計書

## 1. 概要

本設計書は、既存のボードゲームカフェシステムにオーダー機能を追加するためのAWSアーキテクチャ設計を記述します。30テーブル程度の小規模なカフェを想定し、シンプルかつセキュアなサーバーレスアーキテクチャを採用します。

## 2. アーキテクチャ設計

### 全体構成図

```
[ユーザー] → CloudFront → S3(静的コンテンツ)
                ↓
[CloudFront] → Lambda関数URL → DynamoDB(ゲーム/メニュー/オーダー/セッションテーブル)
                ↓
            EventBridge → Lambda(通知処理) → SNS/メール通知
```

### 主要コンポーネント

| コンポーネント | 役割 |
|--------------|------|
| **CloudFront** | コンテンツ配信、基本的なスロットリング |
| **S3** | 静的Webコンテンツのホスティング |
| **Lambda関数URL** | バックエンドAPI処理（認証、テーブル管理、オーダー処理） |
| **DynamoDB** | データストア（テーブルセッション、オーダー情報） |
| **EventBridge** | ステータス変更イベント管理 |
| **SNS** | 通知配信 |
| **WAF** (オプション) | 高度な攻撃防御とレート制限 |

## 3. データモデル設計

### Ordersテーブル

```
- パーティションキー: order_id (UUID)
- ソートキー: created_at (タイムスタンプ)
- 属性:
  - table_number: テーブル番号(1-30)
  - session_id: テーブルセッションID
  - status: "PENDING"|"PROCESSING"|"COMPLETED"|"CANCELED"
  - items: [{ id, name, quantity, price, notes }]
  - total_price: 合計金額
  - customer_notes: 特記事項
  - updated_at: 最終更新時間
```

### TableSessionsテーブル

```
- パーティションキー: table_number (1-30)
- 属性:
  - session_id: セッションUUID
  - status: "AVAILABLE"|"OCCUPIED"
  - access_token: 一時的なアクセストークン
  - created_at: セッション開始時間
  - last_activity: 最終アクティビティ時間
  - expiration_time: セッション有効期限
```

### RateLimitsテーブル (スロットリング用)

```
- パーティションキー: identifier (IP or table_number)
- ソートキー: timestamp
- 属性:
  - request_type: リクエスト種別
  - expiration: TTL値 (自動削除用)
```

## 4. 機能フロー

### テーブル管理フロー

1. **セッション初期化**:
   - 店舗スタッフが管理画面からテーブルセッションを初期化
   - システムがセッションIDとアクセストークンを生成
   - QRコードまたはテーブル番号を顧客に提供

2. **セッション認証**:
   - 顧客がQRコードスキャンまたはテーブル番号入力
   - フロントエンドでアクセストークンを保持
   - 以降のリクエストにテーブル番号とトークンを添付

3. **セッション終了**:
   - 会計時に店舗スタッフがセッションを終了
   - オーダー情報はアーカイブフラグ設定

### オーダーフロー

1. **メニュー表示**:
   - 認証済みセッションでメニュー表示
   - カテゴリ別表示、詳細表示

2. **注文作成**:
   - 顧客がアイテム選択、数量指定、特記事項記入
   - 送信前に確認画面表示、合計金額表示
   - 送信時にセッション再検証

3. **オーダー処理**:
   - スタッフ側で新規オーダー通知
   - ステータス更新（処理中→完了）
   - 顧客側で状態表示

## 5. セキュリティ対策

### 認証・認可

- テーブルセッション方式（テーブル番号＋一時トークン）
- 管理者操作は既存のBasic認証を継続利用
- セッション有効期限の設定（例：3時間）

### スロットリングと不正防止

- **CloudFront+WAF** (オプション):
  - IPベースのレート制限設定
  - 地域制限（必要に応じて）

- **Lambda内カスタム実装**:
  - テーブルごとの最大リクエスト数制限（例：10分あたり15リクエスト）
  - 短時間での重複オーダー検出
  - DynamoDBを使った履歴ベースのレート制限

### セキュリティ検証

- 入力データの厳格なバリデーション
- 権限チェック（テーブル操作、管理者操作）
- トークン有効期限の確認
- リクエストサイズ制限

## 6. Lambda関数一覧

### テーブル管理関数
- `initializeTableSession`: テーブルセッション作成（管理者用）
- `validateTableSession`: セッション検証
- `closeTableSession`: セッション終了（会計時）
- `listActiveTables`: アクティブテーブル一覧（管理者用）

### オーダー処理関数
- `createOrder`: 新規オーダー作成
- `getTableOrders`: テーブルのオーダー一覧取得
- `updateOrderStatus`: ステータス更新（管理者用）
- `cancelOrder`: オーダーキャンセル

### ユーティリティ関数
- `checkRateLimits`: リクエスト頻度制限確認
- `notifyNewOrder`: 新規オーダー通知処理
- `notifyStatusChange`: ステータス変更通知

## 7. 拡張性と将来計画

- **モバイルアプリ対応**:
  - 将来的にモバイルアプリを追加する場合はCognitoと連携
  - 既存のLambda関数URLをモバイル向けにも活用可能

- **分析機能**:
  - オーダー履歴データをS3にエクスポート
  - Athenaによるデータ分析が可能

- **キャパシティ拡張**:
  - テーブル数増加に対応したスケーラビリティ
  - グローバルテーブルによる複数店舗展開可能性

## 8. 実装ロードマップ

1. DynamoDBテーブル設計と作成
2. Lambda関数の実装（基本的なCRUD操作）
3. セッション管理機能の実装
4. CloudFront設定とLambda関数URL連携
5. スロットリング実装
6. 通知機能実装
7. フロントエンド連携
8. テストと検証

---

本設計書は現状のシステム構成を活かしながら、シンプルで堅牢なオーダー機能を追加することを目指しています。スケールは限定的ながら、セキュリティと使いやすさを両立させた設計となっています。